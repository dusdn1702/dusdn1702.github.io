---
title: "[ìš°ì•„í•œí…Œí¬ì½”ìŠ¤] 10ì›” 25ì¼ TIL"
excerpt: "ì˜¤ëŠ˜ì˜ ë°°ìš´ ì  ì •ë¦¬"
permalink: /techcourse/148

categories:
  - techcourse

tags:
  - techcourse

---

## [DB] ì¡°íšŒ ì„±ëŠ¥ ê°œì„ í•˜ê¸°

### SQL

FROM: ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ì§‘í•© ëª…ì‹œ

WHERE: ë°ì´í„°ë¥¼ ê±¸ëŸ¬ë‚¼ ì¡°ê±´

GROUP BY: ê±¸ëŸ¬ë‚¸ ë°ì´í„°ë¥¼ ê·¸ë£¹í™”í•  ì¡°ê±´

HAVING: GROUP BYë¡œ ê·¸ë£¹í™”í•œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì¡°ê±´ì— ë§ê²Œ í•„í„°ë§í•  ì¡°ê±´

SELECT: ì§‘ê³„í•  ë°ì´í„° ëª…ì‹œ

ORDER BY: ë°ì´í„° ì •ë ¬

ì„œë¸Œì¿¼ë¦¬ëŠ” SELECTì ˆ, WHEREì ˆ, FROMì ˆì— ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

JOIN ì‹œì— Aì—ì„œ Bë¥¼ ì¡°ì¸í•˜ë©´ ë“œë¼ì´ë¹™ í…Œì´ë¸”(outer table)ì€ A, ë“œë¦¬ë¸ í…Œì´ë¸”(inner table)ì€ Bì´ë‹¤. ê°€ëŠ¥í•œ ì ì€ ê²°ê³¼ê°€ ë‚˜ì˜¤ëŠ” í…Œì´ë¸”ì„ ë“œë¼ì´ë¹™ í…Œì´ë¸”ì´ ë˜ì–´ì•¼ í•œë‹¤. ë“œë¼ì´ë¹™ìœ¼ë¡œë¶€í„° ì½ì€ ë ˆì½”ë“œì˜ ê±´ìˆ˜ë§Œí¼ ë§¤ë²ˆ ë“œë¦¬ë¸ í…Œì´ë¸”ì„ í’€ í…Œì´ë¸” ìŠ¤ìº”í•´ì•¼í•˜ê¸° ë•Œë¬¸ì´ë‹¤. (mysqlì—ì„œëŠ” join, cross join, inner join ëª¨ë‘ ë™ì¼í•˜ë‹¤)



### MySQL ì•„í‚¤í…ì³

![image](https://user-images.githubusercontent.com/43775108/137312431-e84ef344-4672-4ec3-94b5-db9384fea332.png)

ìµœì í™” ëŒ€ìƒ

1. Client(Connection ì—°ê²°í•˜ê³  ìš”ì²­ ì˜¤ê°€ëŠ” ë¶€ë¶„)

   ì¿¼ë¦¬ ìš”ì²­ ìˆ˜ ì¤„ì´ê¸°

   PreparedStatementë¡œ ì¿¼ë¦¬ë¬¸ì¥ ë¶„ì„, ì»´íŒŒì¼, ì‹¤í–‰ ë‹¨ê³„ ìºì‹±

   DB Connection pool í™œìš©í•´ Connection ì¬ì‚¬ìš©

   Pagingì´ë‚˜ Fetchsize ì¡°ì •ìœ¼ë¡œ ìš”ì²­ ì‚¬ì´ì¦ˆ ì¤„ì´ê¸°

   -> Spring Data Access. Public Cloud, MySQL ë²„ì „ì„ ì˜ í™œìš©í•˜ë©´ ì•Œì•„ì„œ ìµœì í™” ë˜ì–´ìˆë‹¤.  

2. Database Engine

   íŒŒì¼ì‹œìŠ¤í…œì— ì €ì¥ëœ ë°ì´í„°ê°€ ì¡°íšŒë˜ë©´ ê·¸ ë°ì´í„° ì¡°íšŒ ì‹œ I/Oê°€ ì¼ì–´ë‚˜ì§€ ì•Šë„ë¡ í•œë‹¤.

   ì„œë²„ íŒŒë¼ë¯¸í„° íŠœë‹

3. FileSystem

   SSDë¥¼ ì‚¬ìš©í•´ SQLì„ ìµœì í™”í•´ í•„ìš” ì´ìƒì˜ ë°ì´í„° ë¸”ëŸ­ì„ ì½ì§€ ì•Šë„ë¡ ë°©ì§€

```
1. SELECT ì‹œì—ëŠ” ê¼­ í•„ìš”í•œ ì¹¼ëŸ¼ë§Œ
2. WHERE ì ˆì— ê°€ê¸‰ì  ë³„ë„ì˜ ì—°ì‚° ê±¸ì§€ ì•Šê¸°
3. LIKE ì ˆì— ì™€ì¼ë“œì¹´ë“œ ë¬¸ìì—´(%)ì€ String ì•ì— ì˜¤ì§€ ì•Šë„ë¡
4. SELECT DISTINCT, UNION DISTINCTì™€ ê°™ì´ ì¤‘ë³µê°’ ì œê±°ëŠ” ì˜¤ëœ ì‹œê°„ì´ ê±¸ë¦¬ë¯€ë¡œ ë˜ë„ë¡ ì‚¬ìš©í•˜ì§€ ì•Šì„ ê²ƒ
5. ê°™ì€ ë‚´ìš©ì´ë¼ë©´ group by ì—°ì‚° ì‹œ HAVING ë³´ë‹¤ëŠ” WHEREì ˆì´ ìš°ì„ ìˆœìœ„ê°€ ë¹ ë¥´ë¯€ë¡œ íš¨ìœ¨ì 
6. 3ê°œ ì´ìƒì˜ í…Œì´ë¸”ì„ INNER JOINí•  ë•ŒëŠ” í¬ê¸°ê°€ ê°€ì¥ í° í…Œì´ë¸”ì„ FROM ì ˆì—, INNER JOIN ì ˆì—ëŠ” ë‚¨ì€ í…Œì´ë¸”ì„ ì‘ì€ ìˆœì„œëŒ€ë¡œ ë°°ì¹˜ 
7. ìì£¼ ì‚¬ìš©í•˜ëŠ” ë°ì´í„°ì˜ í˜•ì‹ì— ëŒ€í•´ì„œëŠ” ë¯¸ë¦¬ ì „ì²˜ë¦¬ëœ í…Œì´ë¸” ë”°ë¡œ ë³´ê´€í•˜ê¸°
```



### SQL ì¿¼ë¦¬ ë™ì‘ ë°©ì‹

![image](https://user-images.githubusercontent.com/43775108/137314786-015939c6-532e-4bc4-9c8b-40d313e5e60a.png)

1. Query Cache

   SQL ë¬¸ì´ key, ì‹¤í–‰ ê²°ê³¼ê°€ valueê°€ ë˜ì–´ Map í˜•íƒœë¡œ ì €ì¥ë˜ë‹¤ê°€ ë°ì´í„° ë³€ê²½ ì‹œ ëª¨ë‘ ì—†ì–´ì ¸ì•¼ í•œë‹¤ëŠ”ê²Œ ì„±ëŠ¥ ì €í•˜ë¥¼ ì¼ìœ¼ì¼œ 8.0 ë²„ì „ë¶€í„° ì‚­ì œë¨

2. Parser

   ì„œë²„ê°€ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì¿¼ë¦¬ë¬¸ì„ ë¶„ë¦¬

3. Preprocessor

   ë¬¸ë²•ì„ í™•ì¸

4. Optimization

   ì‹¤í–‰ê³„íš(Query execution plan) ì‘ì„±

   - ì¿¼ë¦¬ ë¶„ì„: whereì¸ì§€ joinì¸ì§€
   - ì¸ë±ìŠ¤ ì„ íƒ: í…Œì´ë¸” ì¡°ê±´ê³¼ ì¸ë±ìŠ¤ë¥¼ í†µí•´ ì‚¬ìš©í•  ì¸ë±ìŠ¤ ê²°ì •
   - ì¡°ì¸ ì²˜ë¦¬: ì—¬ëŸ¬ í…Œì´ë¸”ì— ì¡°ì¸ì´ ëœ ê²½ìš° ì–´ë–¤ ìˆœì„œë¡œ í…Œì´ë¸”ì„ ì½ì„ì§€ ê²°ì •

5. Handler

   ì‹¤í–‰ ì—”ì§„(Query Execution Engine)ì˜ ìš”ì²­ì— ë”°ë¼ ë°ì´í„°ë¥¼ ë””ìŠ¤í¬ì— ì €ì¥í•˜ê³  ì½ì–´ì˜¤ëŠ” ì—­í•  ìˆ˜í–‰



### ì‹¤í–‰ ê³„íš

mysql workbenchì—ì„œ ë‹ë³´ê¸°ë¥¼ í†µí•´ ì‹¤í–‰ ê³„íšì„ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

`EXPLAIN SELECT * FROM 'table';`ë¥¼ í†µí•´ì„œë„ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

![image](https://user-images.githubusercontent.com/43775108/137423674-10601098-c671-4c47-87c9-5646ecfc62e6.png)

0.2ê°€ ì¿¼ë¦¬ë¬¸ì— ëŒ€í•œ ë¹„ìš©(evaluation cost)ì„ ë‚˜íƒ€ë‚´ê³ , 1rowê°€ ì¡°íšŒí•œ ë¡œìš° ìˆ˜ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.

- id

  sqlë¬¸ì´ ìˆ˜í–‰ë˜ëŠ” ìˆœì„œ

  ê°™ì€ idëŠ” joinì˜ ê²½ìš°

- Select_type

  - ğŸ‘simple: ë‹¨ìˆœí•œ select ë¬¸
  - ğŸ‘Primary: ì„œë¸Œì¿¼ë¦¬ë¥¼ ê°ì‹¸ëŠ” ì™¸ë¶€ ì¿¼ë¦¬, union ìˆìœ¼ë©´ ì²«ë²ˆì§¸ select ë¬¸
  - subquery: ë…ë¦½ì ìœ¼ë¡œ ìˆ˜í–‰ë˜ëŠ” ì„œë¸Œì¿¼ë¦¬(select, whereì ˆì— ì¶”ê°€ëœ ê²½ìš°)
  - ğŸ‘Derived: from ì ˆì— ì‘ì„±ëœ ì„œë¸Œì¿¼ë¦¬
  - union: union, union allë¡œ í•©ì³ì§„ select
  - ğŸ‘dependent subquery: ì„œë¸Œì¿¼ë¦¬ê°€ ë°”ê¹¥ìª½ select ì¿¼ë¦¬ì— ì •ì˜ëœ ì»¬ëŸ¼ ì‚¬ìš©
  - ğŸ‘dependent union: ì™¸ë¶€ì— ì •ì˜ëœ ì»¬ëŸ¼ì„ unionìœ¼ë¡œ ê²°í•©ëœ ì¿¼ë¦¬ì—ì„œ ì‚¬ìš©
  - materialized: in ì ˆ êµ¬ë¬¸ì˜ ì„œë¸Œì¿¼ë¦¬ë¥¼ ì„ì‹œ í…Œì´ë¸”ì— ìƒì„±í•œ í›„ ì¡°ì¸ ìˆ˜í–‰
  - ğŸ‘uncacheable subquery: RAND(), UUID() ë“± ì¡°íšŒë§ˆë‹¤ ê²°ê³¼ ë‹¬ë¼ì§€ëŠ” ê²½ìš° ì‚¬ìš©

- type

  - ğŸ‘system: í…Œì´ë¸”ì— ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í•˜ë‚˜ë§Œ ìˆëŠ” ê²½ìš°
  - ğŸ‘const: ì¡°íšŒë˜ëŠ” ë°ì´í„°ê°€ í•˜ë‚˜ì¸ ê²½ìš°
  - ğŸ‘eq_ref: ì¡°ì¸ì´ ìˆ˜í–‰ë ë•Œ ë“œë¦¬ë¸ í…Œì´ë¸”ì˜ ë°ì´í„°ì— PK í˜¹ì€ ê³ ìœ  ì¸ë±ìŠ¤ë¡œ ë‹¨ í•˜ë‚˜ì˜ ë°ì´í„° ì¡°íšŒ
  - ref: eq_refì™€ ê°™ìœ¼ë‚˜ ë°ì´í„°ê°€ 2ê°œ ì´ìƒ
  - ğŸ‘index: ì¸ë±ìŠ¤ í’€ ìŠ¤ìº”
  - range: ì¸ë±ìŠ¤ ë ˆì¸ì§€ ìŠ¤ìº”
  - ğŸ‘all: í…Œì´ë¸” í’€ ìŠ¤ìº”

- key

  ì˜µí‹°ë§ˆì´ì €ê°€ ì‹¤ì œë¡œ ì„ íƒí•œ ì¸ë±ìŠ¤

- rows

  sqlë¬¸ ìˆ˜í–‰ì„ ìœ„í•´ ì ‘ê·¼í•˜ëŠ” ë°ì´í„°ì˜ ëª¨ë“  í–‰ ìˆ˜

- extra

  - distinct: ì¤‘ë³µ ì œê±°
  - using where: where ì ˆë¡œ í•„í„°
  - ğŸ‘using temporary: ì¤‘ê°„ê²°ê³¼ ì €ì¥ì„ ìœ„í•œ ì„ì‹œ í…Œì´ë¸” ìƒì„± (distinct, group by, order byì˜ êµ¬ë¬¸ í¬í•¨ëœ ê²½ìš°)
  - ğŸ‘using index: ë¬¼ë¦¬ì ì¸ ë°ì´í„° íŒŒì¼ì´ ì•„ë‹Œ ì¸ë±ìŠ¤ë§Œ ì½ì–´ì„œ ì²˜ë¦¬
  - ğŸ‘using filesort: ì •ë ¬



### DB ì„œë²„ íŠœë‹

#### 1. ë©”ëª¨ë¦¬ íŠœë‹

- Thread

  ì»¤ë„¥ì…˜ í•˜ë‚˜ì— thread í•˜ë‚˜ë¡œ ë©”ëª¨ë¦¬ í• ë‹¹ê³¼ í•´ì œì— ë“œëŠ” ë¹„ìš© ì¤„ì´ê¸°

  ```
  ## í˜„ì¬ ì“°ë ˆë“œ(ì—°ê²°) ê°œìˆ˜ í™•ì¸
  SELECT * FROM performance_schema.threads
  
  SHOW STATUS LIKE '%THREAD%';
  ```

  

- Caching

  ë‚´ë¶€ì ìœ¼ë¡œ í•˜ë‚˜ì˜ Global Buffer

  Threadë³„ë¡œ Thread Buffer

  Thread Bufferì— ë§ì€ ë©”ëª¨ë¦¬ê°€ í• ë‹¹ë˜ë©´ ì„±ëŠ¥ì€ ì¢‹ì•„ì§€ì§€ë§Œ ì„¤ì •ê°’ * Connection ìˆ˜ë§Œí¼ í™•ë³´í•´ Connectionì´ ê¸‰ì¦í•˜ë©´ ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•´ì ¸ swap ë°œìƒí•  ìˆ˜ ìˆìŒ

  - innodb_buffer_pool_size

    InnoDBì˜ ë°ì´í„°ë‚˜ ì¸ë±ìŠ¤ë¥¼ ìºì‹œí•˜ê¸° ìœ„í•œ ë©”ëª¨ë¦¬ ìƒì˜ ì˜ì—­ìœ¼ë¡œ Global Bufferë¼ ì‹œìŠ¤í…œ ì „ì²´ ë©”ëª¨ë¦¬ì˜ 80% ìˆ˜ì¤€ìœ¼ë¡œ ì„¤ì • (ìµœëŒ€ 512MB)

  - key_buffer_size

    ì¸ë±ìŠ¤ë¥¼ ë©”ëª¨ë¦¬ì— ì €ì¥í•˜ëŠ” ë²„í¼ í¬ê¸°ë¡œ ì´ ë©”ëª¨ë¦¬ì˜ 25%ë¡œ ì„¤ì •

    key_buffer ì‚¬ìš©ë¥ : 1-((Key_reads/Key_read_requests)*100)

    ì‚¬ìš©ë¥  90% ì´ìƒì´ë©´ íš¨ìœ¨ì ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆë‹¤ê³  íŒë‹¨



#### 2. ì»¤ë„¥ì…˜ íŠœë‹

```sql
SHOW VARIABLES LIKE '%max_connection%';
SHOW STATUS LIKE '%CONNECT%';
SHOW STATUS LIKE '%CLIENT%';
```

- Connection_timeout

  mysqlì´ í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ì ‘ì† ìš”ì²­ì„ ë°›ì„ ë•Œ ëª‡ì´ˆ ê¸°ë‹¤ë¦´ì§€ ì„¤ì •í•˜ëŠ” ë³€ìˆ˜

  ê¸°ë³¸ ê°’ 5ì´ˆ, ìˆ˜ì •í•  í•„ìš” ì—†ìŒ

- Interactive_timeout

  í„°ë¯¸ë„ì—ì„œ ì ‘ì†í•  ì‹œê°„

  ê¸°ë³¸ ê°’ 8ì‹œê°„, 1ì‹œê°„ ì •ë„ê°€ ì¢‹ìŒ

- Wait_timeout

  ì»¤ë„¥ì…˜ì´ ì ‘ì†í•œ í›„ ì¿¼ë¦¬ê°€ ë“¤ì–´ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„

  DBMSì—ì„œëŠ” ì´ê±¸ ë‚®ì¶° sleepí•˜ëŠ” Connectionì„ ì •ë¦¬í•´ ì „ì²´ ì„±ëŠ¥ í–¥ìƒ

  ê°’ì„ ë„ˆë¬´ ë‚®ì¶”ë©´ ë„ˆë¬´ ì¦ì€ ì»¤ë„¥ì…˜ì´ ìƒê¸°ë¯€ë¡œ 15~20 ê°’ ì„¤ì •

  aborted client ëŠ” 2% ì•„ë˜

- max_connections

  ì„œë²„ê°€ í—ˆìš©í•˜ëŠ” ìµœëŒ€ì˜ ì»¤ë„¥ì…˜ ìˆ˜

  ì¼ë°˜ì ìœ¼ë¡œ 150~250 ê°œ ì„¤ì •

  ì ‘ì†ì´ ë§ê³  ê³ ìš©ëŸ‰ì¸ ê²½ìš° 1000ê°œ ì •ë„ì˜ ë†’ì€ ê°’ ì„¤ì • ê°€ëŠ¥

  too many connection ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ì ì ˆí•œ ê°’ ì„¤ì •

- back_log

  max_connection ì„¤ì •ê°’ ì´ìƒì˜ ì ‘ì†ì´ ë°œìƒí•  ë•Œ ì–¼ë§ˆì˜ ì»¤ë„¥ì…˜ì„ íì— ë³´ê´€í•  ì§€ì— ëŒ€í•œ ì„¤ì •

  ê¸°ë³¸ê°’ 50, ì ‘ì† ë§ì€ ì„œë²„ëŠ” ëŠ˜ë¦¬ëŠ” ê²ƒì´ ì¢‹ìŒ

  

### Index

- Sequential Access

  ë¬¼ë¦¬ì ìœ¼ë¡œ ì¸ì ‘í•œ í˜ì´ì§€ë¥¼ ì°¨ë¡€ëŒ€ë¡œ ì½ëŠ”ë‹¤. ì¸ì ‘í•œ í˜ì´ì§€ë¥¼ ì—¬ëŸ¬ ê°œ ì½ëŠ” ë°ì— ìš©ì´í•˜ë‹¤.

- Random Access

  ì •í•´ì§„ ìˆœì„œ ì—†ì´ ì´ë™í•´ ë””ìŠ¤í¬ì˜ ë¬¼ë¦¬ì ì¸ ì›€ì§ì„ì´ í•„ìš”í•˜ë‹¤. ë‹¤ì¤‘ í˜ì´ì§€ ì½ê¸°ê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ì£¼ì†Œë¥¼ ì•Œê³  ìˆì„ ë•Œ ë” ì‰½ê²Œ ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.



DB tableì—ì„œ ë°ì´í„°ë¥¼ ì°¾ëŠ” ë°©ë²•

- Table Full Scan

  sequential access + MultiBlock I/O 

  íŒŒí‹°ì…˜ í™œìš©ê³¼ ë³‘ë ¬ì²˜ë¦¬ë¡œ í•´ê²° ê°€ëŠ¥

- Index Range Scan

  random access + Single Block I/O

  ë ˆì½”ë“œ í•˜ë‚˜ë¥¼ ì½ê¸° ìœ„í•´ ë§¤ë²ˆ I/Oê°€ ë°œìƒí•œë‹¤ëŠ” ë‹¨ì ì´ ìˆì–´ í° í…Œì´ë¸”ì—ì„œ ì†ŒëŸ‰ ë°ì´í„°ë¥¼ ê²€ìƒ‰í•  ë•Œ ìœ ë¦¬

  ë”°ë¼ì„œ ì´ íšŸìˆ˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´ ìŠ¤ìº” ë²”ìœ„ë¥¼ ì¤„ì´ëŠ” ê²ƒì´ ì¤‘ìš”



ì¸ë±ìŠ¤ëŠ” MySQLì€ InnoDBë¥¼ ì‚¬ìš©í•´ B-Tree ì•Œê³ ë¦¬ì¦˜ì„ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©í•´ `ë£¨íŠ¸ ë…¸ë“œ`, `ë¸Œëœì¹˜ ë…¸ë“œ`, `ë¦¬í”„ ë…¸ë“œ`ë¡œ ì´ë£¨ì–´ì ¸ ìˆë‹¤.

ìŠ¤ìº”ì˜ ì‹œì‘ê³¼ ë ì§€ì ì„ ì°¾ëŠ” **ìˆ˜ì§ì  íƒìƒ‰**ì´ ìˆê³ , ë°ì´í„°ë¥¼ ì°¾ëŠ” **ìˆ˜í‰ì  íƒìƒ‰**ì´ ìˆë‹¤.

ë£¨íŠ¸ ë…¸ë“œì™€ ë¸Œëœì¹˜ ë…¸ë“œëŠ” ì¸ë±ìŠ¤ í‚¤ì™€ ìì‹ ë…¸ë“œ ì •ë³´ë¡œ êµ¬ì„±ëœ í˜ì´ì§€ë¡œ êµ¬ì„±ë˜ì–´ ìˆì–´ rangeë¥¼ ì¤„ì´ê¸° ìœ„í•´ ìŠ¤ìº”ì˜ ì‹œì‘ê³¼ ë ì§€ì ì„ ì°¾ê¸° ìœ„í•œ **ìˆ˜ì§ì  íƒìƒ‰**ì´ ë“¤ì–´ê°„ë‹¤. 

ë¦¬í”„ ë…¸ë“œëŠ” ì–‘ë°©í–¥ Linked Listë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. í•„ìš”í•œ ì»¬ëŸ¼ì„ ì¸ë±ìŠ¤ê°€ ëª¨ë‘ ê°–ê³  ìˆëŠ” ê²½ìš°ëŠ” ì¸ë±ìŠ¤ë§Œ ìŠ¤ìº”í•˜ë©´ ë˜ì§€ë§Œ ì•„ë‹Œ ê²½ìš°ëŠ” ROWID(ë°ì´í„°ë¸”ëŸ­ ì£¼ì†Œ + ë¡œìš° ë²ˆí˜¸)ë¥¼ í†µí•´ í…Œì´ë¸” ì•¡ì„¸ìŠ¤ê°€ í•„ìš”í•˜ë‹¤. Primary KeyëŠ” Clustered Indexë¡œ ìˆœì°¨ì ìœ¼ë¡œ ì €ì¥ë˜ì–´ ìˆì–´ ë¬¼ë¦¬ì  ìœ„ì¹˜ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤. ë°ì´í„° í˜ì´ì§€ê°€ ë²„í¼ í’€ì— ìˆëŠ”ì§€ í™•ì¸í•´ë³´ê³  ì—†ìœ¼ë©´ ë””ìŠ¤í¬ì—ì„œ ì½ì–´ì˜¨ë‹¤. ì½ìœ¼ë©´ ë²„í¼í’€ì— ì ì¬í•œë‹¤. ì´ê²Œ **ìˆ˜í‰ì  íƒìƒ‰**ì´ë‹¤.

Secondary Index íƒìƒ‰ -> Primary key Index íƒìƒ‰ ìœ¼ë¡œ ì´ë£¨ì–´ì§

í•˜ì§€ë§Œ ê²°ê³¼ì ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ í†µí•´ í…Œì´ë¸”ì— ì ‘ê·¼í•˜ëŠ” ê²½ìš°ê°€ ë§ì•„ì§ˆ ê²½ìš° table full scan ì²˜ë¦¬ ì‹œê°„ì€ ë™ì¼í•œë° ëœë¤ ì•¡ì„¸ìŠ¤ ë•Œë¬¸ì— ì˜¤íˆë ¤ ëŠë ¤ì§„ë‹¤.

> ì—¬ëŸ¬ ì“°ë ˆë“œê°€ dbì— ì ‘ì†í•´ì„œ íŠ¸ëœì­ì…˜ ë•Œë¬¸ì— ë³‘ëª©ì´ ë°œìƒí•˜ë¯€ë¡œ OLTP í™˜ê²½ì—ì„œëŠ” indexê°€ ì¢‹ìŒ

#### ìƒì„±

column ì£¼ëŠ” ìˆœì„œê°€ ë§¤ìš° ì¤‘ìš”í•˜ë‹¤. ìˆœì„œì— ë”°ë¼ì„œ index tableì´ ìƒì„±ë˜ê¸° ë•Œë¬¸ì—

```sql
CREATE INDEX `idx_user_id`  ON `subway`.`programmer` (id)
CREATE INDEX `idx_user_Country_OpenSource`  ON `subway`.`programmer` (Country, OpenSource) 
```

#### ì‚­ì œ

```sql
DROP INDEX `idx_user_id` ON `subway`.`programmer`
```

- index range scan

  ì¸ë±ìŠ¤ ì„ ë‘ ì»¬ëŸ¼ì´ ì¡°ê±´ì ˆì— ì¡´ì¬í•´ì•¼ í•œë‹¤.

  ```sql
  CREATE INDEX `idx_user_Country_OpenSource`  ON `subway`.`programmer` (Country, OpenSource) 
  ```

- index full scan

  ë¦¬í”„ ë¸”ë¡ ì „ì²´ ìŠ¤ìº”í•  ë•Œ (select *)

- index unique scan

  ì¸ë±ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ì´ ì¤‘ë³µê°’ì´ ì…ë ¥ë˜ì–´ ìˆì§€ ì•Šì•„ '='ë¡œ ê²€ìƒ‰í•´ í•˜ë‚˜ë¡œë§Œ ê°€ë©´ ë  ë•Œ

indexê°€ ê±¸ë ¤ìˆì–´ë„ scaní•  ë²”ìœ„ê°€ ë§ìœ¼ë©´ randomë³´ë‹¤ sequentialì´ íš¨ìœ¨ì ì´ê¸°ì— full table scanì´ ë“¤ì–´ê°„ë‹¤. mysqlì€ mysql engineê³¼ storage engineì´ ìˆëŠ”ë° ì–´ëŠ ì—”ì§„ì—ì„œ filterë¥¼ ê±°ëŠ” ê²ƒì´ íš¨ìœ¨ì ì¼ì§€ë¥¼ íŒë‹¨í•˜ê³  ì‹¤í–‰í•˜ëŠ” ê²ƒì´ë‹¤.



### ì¸ë±ìŠ¤ íŠœë‹

ì¸ë±ìŠ¤ ìŠ¤ìº” íš¨ìœ¨í™”

ëœë¤ ì•¡ì„¸ìŠ¤ ìµœì†Œí™”

```sql
## í”„ë¡œì„¸ìŠ¤ ëª©ë¡
SHOW PROCESSLIST;

## ìŠ¬ë¡œìš° ì¿¼ë¦¬ í™•ì¸
SELECT query, exec_count, sys.format_time(avg_latency) AS "avg latency", rows_sent_avg, rows_examined_avg, last_seen
FROM sys.x$statement_analysis
ORDER BY avg_latency DESC;

## ì„±ëŠ¥ ê°œì„  ëŒ€ìƒ ì‹ë³„
SELECT DIGEST_TEXT AS query,
             IF(SUM_NO_GOOD_INDEX_USED > 0 OR SUM_NO_INDEX_USED > 0, '*', '') AS full_scan,
             COUNT_STAR AS exec_count,
             SUM_ERRORS AS err_count,
             SUM_WARNINGS AS warn_count,
             SEC_TO_TIME(SUM_TIMER_WAIT/1000000000000) AS exec_time_total, 
             SEC_TO_TIME(MAX_TIMER_WAIT/1000000000000) AS exec_time_max, 
             SEC_TO_TIME(AVG_TIMER_WAIT/1000000000000) AS exec_time_avg_ms, SUM_ROWS_SENT AS rows_sent,
             ROUND(SUM_ROWS_SENT / COUNT_STAR) AS rows_sent_avg, SUM_ROWS_EXAMINED AS rows_scanned,
             DIGEST AS digest
   FROM performance_schema.events_statements_summary_by_digest ORDER BY SUM_TIMER_WAIT DESC

##  I/O ìš”ì²­ì´ ë§ì€ í…Œì´ë¸” ëª©ë¡
SELECT * FROM sys.io_global_by_file_by_bytes WHERE file LIKE '%ibd';

## í…Œì´ë¸”ë³„ ì‘ì—…ëŸ‰ í†µê³„ 
SELECT table_schema, table_name, rows_fetched, rows_inserted, rows_updated, rows_deleted, io_read, io_write
FROM sys.schema_table_statistics
WHERE table_schema NOT IN ('mysql', 'performance_schema', 'sys');

## ìµœê·¼ ì‹¤í–‰ëœ ì¿¼ë¦¬ ì´ë ¥ ê¸°ëŠ¥ í™œì„±í™”
UPDATE performance_schema.setup_consumers SET ENABLED = 'yes' WHERE NAME = 'events_statements_history'
UPDATE performance_schema.setup_consumers SET ENABLED = 'yes' WHERE NAME = 'events_statements_history_long'

## ìµœê·¼ ì‹¤í–‰ëœ ì¿¼ë¦¬ ì´ë ¥ í™•ì¸
SELECT * FROM performance_schema.events_statements_history
```

í…Œì´ë¸” ì•¡ì„¸ìŠ¤ ìµœì†Œí™”

- ì¸ë±ìŠ¤ ì»¬ëŸ¼ ì¶”ê°€

  ì¸ë±ìŠ¤ëŠ” ì •ë ¬ë˜ë¯€ë¡œ ì¡°ê±´ì ˆì— í•´ë‹¹í•˜ëŠ” pk ë²”ìœ„ë¥¼ ì¤„ì—¬ ëœë¤ ì•¡ì„¸ìŠ¤ íšŸìˆ˜ê°€ ì¤„ì–´ë“¤ê²Œ í•  ìˆ˜ ìˆë‹¤.



### ì¿¼ë¦¬ íŠœë‹

1. ì¸ë±ìŠ¤

   - ì¸ë±ìŠ¤ ì»¬ëŸ¼ì„ ê°€ê³µí•˜ì§€ ë§ê¸°

     ì´ë¯¸ ì •ë ¬ëœ ì¸ë±ìŠ¤ë¥¼ ê°€ê³µí•˜ë©´ ì¸ë±ìŠ¤ë¥¼ íƒˆ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ì•„ë˜ì™€ ê°™ì´ ì»¬ëŸ¼ ê°€ê³µí•˜ì§€ ë§ ê²ƒ

     - <>, NOT IN, NOT BETWEENê³¼ ê°™ì€ NOT-EQUALë¡œ ë¹„êµëœ ê²½ìš°
     - LIKE '%??'
     - SUBSTRING(column, 1, 1), DAYOFMONTH(coulmn)ê³¼ ê°™ì´ ì¸ë±ìŠ¤ ì¹¼ëŸ¼ì´ ë³€í˜•ëœ ê²½ìš°
     - WHERE char_column = 10 ê³¼ ê°™ì´ ë°ì´í„° íƒ€ì…ì´ ë‹¤ë¥¸ ë¹„êµ

   - ì¸ë±ìŠ¤ ìˆœì„œ ê³ ë ¤í•˜ê¸°

     ì¸ë±ìŠ¤ëŠ” í•­ìƒ ì •ë ¬ëœì–´ ìˆìœ¼ë¯€ë¡œ Group by, Order byì™€ ê°™ì€ ì •ë ¬ ì—°ì‚°ì´ í•„ìš” ì—†ë‹¤.

     ì¡°ê±´ì ˆì— í•­ìƒ ë“¤ì–´ê°€ê±°ë‚˜ ìì£¼ ì‚¬ìš©í•˜ëŠ” ì»¬ëŸ¼ì„ ì¸ë±ìŠ¤ë¡œ ì„ ì •

     =ìœ¼ë¡œ ìì£¼ ì¡°íšŒí•˜ëŠ” ì»¬ëŸ¼ì„ ì• ìª½ì— ì¸ë±ìŠ¤ ë¶€ì—¬

     ì˜ˆë¥¼ ë“¤ì–´ `ê³¼ì„¸ì½”ë“œ+ì´ë¦„+ì—°ë ¹`ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ ë¶€ì—¬í–ˆì„ ë•Œ, ê³¼ì„¸ì½”ë“œë¡œ ì •ë ¬ -> ì´ë¦„ìœ¼ë¡œ ì •ë ¬ -> ì—°ë ¹ìœ¼ë¡œ ì •ë ¬ëœ ìƒíƒœì´ë¯€ë¡œ `ê³¼ì„¸ì½”ë“œ`ë‚˜ `ê³¼ì„¸ì½”ë“œ + ì´ë¦„`ì˜ ì¸ë±ìŠ¤ê°€ ë¶ˆí•„ìš”

   - ì¸ë±ìŠ¤ë¥¼ ì œëŒ€ë¡œ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸

     ì¡°ê±´ ì ˆì—ì„œ ë” íš¨ìœ¨ì ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆëŠ”ì§€ í™•ì¸, ë” ì ì€ í•„í„°ë§ì„ í•  ìˆ˜ ìˆë„ë¡ ê³ ë¯¼

     Covered Indexì™€ ê°™ì´ ì¸ë±ìŠ¤ ê³¼ì •ì—ì„œ ì–»ì€ ì •ë³´ë§Œìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´ í…Œì´ë¸” ì•¡ì„¸ìŠ¤ê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ” ì¿¼ë¦¬ë¡œ ì¸ë±ìŠ¤ë¥¼ ê°€ì¥ ì˜ í™œìš©í•˜ëŠ” ê²½ìš°

   - ë³µí•© ì¸ë±ìŠ¤ ì‹œ ë²”ìœ„ ê²€ìƒ‰ì»¬ëŸ¼ì„ ë’¤ì—

     betweenê³¼ ê°™ì€ ë²”ìœ„ ê²€ìƒ‰ì„ ë’¤ì— ë‘ì–´ì•¼ í•œë‹¤. ìµœì†Œí•œì˜ rangeë¥¼ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ í•´ì•¼ í•œë‹¤.

     ì •ë ¬ëœ ìƒíƒœì—ì„œ ì–´ë–»ê²Œ íƒìƒ‰ì´ ë“¤ì–´ê°€ì•¼ ì¢‹ì„ ì§€ ê³ ë¯¼

     ì‚¬ì›ë²ˆí˜¸ê°€ ì„ í–‰ë˜ë©´ 2ì¹¸, ì…ì¶œì…ì‹œê°„ì´ ì„ í–‰ë˜ë©´ 5ì¹¸ì¸ ê²ƒì²˜ëŸ¼..

   - ì¸ë±ìŠ¤ êµ¬ì„± í™•ì¸í•˜ê¸°

     ```sql
     ## í…Œì´ë¸” / ì¸ë±ìŠ¤ í¬ê¸° í™•ì¸
     SELECT
         table_name,
         table_rows,
         round(data_length/(1024*1024),2) as 'DATA_SIZE(MB)',
         round(index_length/(1024*1024),2) as 'INDEX_SIZE(MB)'
     FROM information_schema.TABLES
     where table_schema = 'subway';
     
     ## ë¯¸ì‚¬ìš© ì¸ë±ìŠ¤ í™•ì¸
     SELECT * FROM sys.schema_unused_indexes;
     
     ## ì¤‘ë³µ ì¸ë±ìŠ¤ í™•ì¸
     SELECT * FROM sys.schema_redundant_indexes;
     ```

2. ì¡°ì¸ë¬¸

   - ì¡°ì¸ ì—°ê²° key ë“¤ì€ ì–‘ìª½ ë‹¤ ì¸ë±ìŠ¤ë¥¼ ê°€ì§€ëŠ” ê²ƒì´ ì¢‹ë‹¤.

     í•œìª½ì—ë§Œ ì¸ë±ìŠ¤ê°€ ìˆìœ¼ë©´ Join buffer, ì–‘ìª½ì— ìˆìœ¼ë©´ ì¤‘ì²© ë£¨í”„ ì¡°ì¸ì„ í•œë‹¤. ì¤‘ì²© ë£¨í”„ ì¡°ì¸ì´ íš¨ìœ¨ì ì¸ë°ë‹¤ê°€ ì¸ë±ìŠ¤ê°€ ìˆëŠ” í…Œì´ë¸”ì´ ë“œë¼ì´ë¹™ í…Œì´ë¸”ì´ ë˜ë¯€ë¡œ ì£¼ì˜

   - ë°ì´í„°ê°€ ì ì€ í…Œì´ë¸”ì„ ëœë¤ì•¡ì„¸ìŠ¤í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

     ë“œë¼ì´ë¹™ í…Œì´ë¸”ì˜ ë°ì´í„°ê°€ ì ì„ ê²½ìš° ì¤‘ì²© ë£¨í”„ ì¡°ì¸ì„ ìˆ˜í–‰í•´ ë“œë¦¬ë¸ í…Œì´ë¸”ì˜ ë§ì€ ì–‘ì˜ ë°ì´í„°ì— ì¸ë±ìŠ¤ ìŠ¤ìº”ì„ í•˜ëŠ”ë° ë“œë¦¬ë¸ í…Œì´ë¸”ì˜ pkë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ë¹„íš¨ìœ¨ì ì´ë‹¤.

     ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë©´ pkë¥¼ ì•Œì•„ë‚´ì„œ ëœë¤ì•¡ì„¸ìŠ¤ í•˜ëŠ”ê²Œ ë„ˆë¬´ ë§ì•„ì§€ë©´ ë“œë¼ì´ë¹™ì´ ì ì€ê²Œ ì¢‹ì§€ ì•Šì„ ìˆ˜ë„ ìˆë‹¤.

   - ëª¨ìˆ˜ í…Œì´ë¸” í¬ê¸°ë¥¼ ì¤„ì´ëŠ” ê²ƒì´ ì¢‹ë‹¤.

     ì „ì²´ë¡œ joinì„ ê±°ëŠ” ê²ƒë³´ë‹¤ ì„œë¸Œì¿¼ë¦¬ë‚˜ from ì ˆì— ë¯¸ë¦¬ ê±¸ì–´ì„œ ê°€ì§€ê³  ì˜¤ëŠ” í…Œì´ë¸” ì‚¬ì´ì¦ˆë¥¼ ì¤„ì´ëŠ” ê²ƒì„ ê³ ë¯¼í•´ë³´ì

   - ì„œë¸Œì¿¼ë¦¬ë³´ë‹¤ëŠ” ì¡°ì¸ë¬¸ í™œìš©í•˜ê¸°

     [ì°¸ê³ -ìŠ¤íƒì˜¤ë²„í”Œë¡œìš°](https://stackoverflow.com/questions/2577174/join-vs-sub-query), [ì°¸ê³ -ë¬¸ì„œ](https://dev.mysql.com/doc/refman/5.7/en/rewriting-subqueries.html)

     5.6 ë²„ì „ ì´í›„ë¡œ semi join, materializedì™€ ê°™ì€ ì„œë¸Œì¿¼ë¦¬ ìµœì í™”ê°€ ì´ë£¨ì–´ì§€ì§€ë§Œ update, deleteëŠ” ì—¬ì „íˆ ì•ˆë˜ë¯€ë¡œ ì¡°ì¸ë¬¸ ì‚¬ìš©í•˜ê¸°



### ì¿¼ë¦¬ íŠœë‹ ë¯¸ì…˜

#### ì¿¼ë¦¬ì—°ìŠµ

- í™œë™ì¤‘ì¸(Active) ë¶€ì„œì˜ í˜„ì¬ ë¶€ì„œê´€ë¦¬ì ì¤‘ ì—°ë´‰ ìƒìœ„ 5ìœ„ì•ˆì— ë“œëŠ” ì‚¬ëŒë“¤ì´ ìµœê·¼ì— ê° ì§€ì—­ë³„ë¡œ ì–¸ì œ í‡´ì‹¤í–ˆëŠ”ì§€ ì¡°íšŒí•´ë³´ì„¸ìš”.
  (ì‚¬ì›ë²ˆí˜¸, ì´ë¦„, ì—°ë´‰, ì§ê¸‰ëª…, ì§€ì—­, ì…ì¶œì…êµ¬ë¶„, ì…ì¶œì…ì‹œê°„)

  - 1ì°¨ 1.527sec, ë‹µì€ ë§ì§€ë§Œ 5ëª… ì œí•œ ì—†ìŒ

    ```sql
    select ì‚¬.ì‚¬ì›ë²ˆí˜¸, ì›.ì´ë¦„, ê¸‰.ì—°ë´‰, ì§.ì§ê¸‰ëª…, ì‚¬.ì§€ì—­, ì‚¬.ì…ì¶œì…êµ¬ë¶„, ì‚¬.ì…ì¶œì…ì‹œê°„ 
    from ê¸‰ì—¬ ê¸‰
    inner join ë¶€ì„œê´€ë¦¬ì ê´€ on ê´€.ì‚¬ì›ë²ˆí˜¸ = ê¸‰.ì‚¬ì›ë²ˆí˜¸
    inner join ë¶€ì„œ ë¶€ on ê´€.ë¶€ì„œë²ˆí˜¸ = ë¶€.ë¶€ì„œë²ˆí˜¸
    inner join ì‚¬ì›ì¶œì…ê¸°ë¡ ì‚¬ on ì‚¬.ì‚¬ì›ë²ˆí˜¸ = ê´€.ì‚¬ì›ë²ˆí˜¸
    inner join ì‚¬ì› ì› on ì›.ì‚¬ì›ë²ˆí˜¸ = ì‚¬.ì‚¬ì›ë²ˆí˜¸
    inner join ì§ê¸‰ ì§ on ì§.ì‚¬ì›ë²ˆí˜¸ = ì›.ì‚¬ì›ë²ˆí˜¸
    where ì‚¬.ì…ì¶œì…êµ¬ë¶„ = 'O' and ì§.ì§ê¸‰ëª… = 'Manager' and ë¶€.ë¹„ê³  = 'Active' and ê¸‰.ì¢…ë£Œì¼ì > ì‚¬.ì…ì¶œì…ì‹œê°„ and ì§.ì¢…ë£Œì¼ì > ì‚¬.ì…ì¶œì…ì‹œê°„
    order by ê¸‰.ì—°ë´‰ desc;
    ```

    ![ìŠ¤í¬ë¦°ìƒ· 2021-10-16 ì˜¤í›„ 6 47 03](https://user-images.githubusercontent.com/43775108/137582972-d58cf610-9459-4518-b8ef-8016fa9e942b.png)

  - 2ì°¨ 0.654sec, where ì ˆì„ ê° join ë¬¸ì— ì„œë¸Œì¿¼ë¦¬ë¡œ ì£¼ì–´ ê°œì„ , 5ëª… ì œí•œ ì—†ìŒ

    ```sql
    select ì‚¬.ì‚¬ì›ë²ˆí˜¸, ì‚¬ì›.ì´ë¦„, ê¸‰.ì—°ë´‰, ì§.ì§ê¸‰ëª…, ì‚¬.ì§€ì—­, ì‚¬.ì…ì¶œì…êµ¬ë¶„, ì‚¬.ì…ì¶œì…ì‹œê°„ 
    from ì‚¬ì› ì‚¬ì›
    inner join ë¶€ì„œê´€ë¦¬ì ê´€ on ê´€.ì‚¬ì›ë²ˆí˜¸ = ì‚¬ì›.ì‚¬ì›ë²ˆí˜¸
    inner join (select ì‚¬ì›ë²ˆí˜¸, ì§ê¸‰ëª… from ì§ê¸‰ where ì§ê¸‰ëª… = 'Manager' and ì¢…ë£Œì¼ì = '9999-01-01') ì§ on ì§.ì‚¬ì›ë²ˆí˜¸ = ê´€.ì‚¬ì›ë²ˆí˜¸
    inner join (select ì‚¬ì›ë²ˆí˜¸, ì—°ë´‰ from ê¸‰ì—¬ where ì¢…ë£Œì¼ì = '9999-01-01') ê¸‰ on ê¸‰.ì‚¬ì›ë²ˆí˜¸ = ì§.ì‚¬ì›ë²ˆí˜¸
    inner join (select ë¶€ì„œë²ˆí˜¸ from ë¶€ì„œ where ë¹„ê³  = 'Active') ë¶€ on ê´€.ë¶€ì„œë²ˆí˜¸ = ë¶€.ë¶€ì„œë²ˆí˜¸
    inner join (select ì‚¬ì›ë²ˆí˜¸, ì§€ì—­, ì…ì¶œì…êµ¬ë¶„, ì…ì¶œì…ì‹œê°„ from ì‚¬ì›ì¶œì…ê¸°ë¡ where ì…ì¶œì…êµ¬ë¶„ = 'O') ì‚¬ on ì‚¬.ì‚¬ì›ë²ˆí˜¸ = ê¸‰.ì‚¬ì›ë²ˆí˜¸
    order by ê¸‰.ì—°ë´‰ desc, ì‚¬.ì…ì¶œì…ì‹œê°„ desc;
    ```

    ![ìŠ¤í¬ë¦°ìƒ· 2021-10-16 ì˜¤í›„ 6 46 22](https://user-images.githubusercontent.com/43775108/137582958-4a81f764-ab38-4f35-872d-16fcb067cc27.png)

  - 3ì°¨ 0.427sec, ë¶€ì„œê´€ë¦¬ì ì—°ë´‰ top 5ëª… ê±°ë¥´ê³  ê·¸ë“¤ì˜ ì…ì¶œì… ê¸°ë¡ ë„ì¶œ

    ```sql
    select ë¶€ì„œê´€ë¦¬ìë“¤.ì‚¬ì›ë²ˆí˜¸, ë¶€ì„œê´€ë¦¬ìë“¤.ì´ë¦„, ë¶€ì„œê´€ë¦¬ìë“¤.ì—°ë´‰, ë¶€ì„œê´€ë¦¬ìë“¤.ì§ê¸‰ëª…, ì‚¬.ì§€ì—­, ì‚¬.ì…ì¶œì…êµ¬ë¶„, ì‚¬.ì…ì¶œì…ì‹œê°„ 
    from (select ì‚¬ì›.ì‚¬ì›ë²ˆí˜¸, ì‚¬ì›.ì´ë¦„, ê¸‰.ì—°ë´‰, ì§.ì§ê¸‰ëª… from ì‚¬ì›
    inner join ë¶€ì„œê´€ë¦¬ì ê´€ on ê´€.ì‚¬ì›ë²ˆí˜¸ = ì‚¬ì›.ì‚¬ì›ë²ˆí˜¸
    inner join (select ì‚¬ì›ë²ˆí˜¸, ì§ê¸‰ëª… from ì§ê¸‰ where ì§ê¸‰ëª… = 'Manager' and ì¢…ë£Œì¼ì = '9999-01-01') ì§ on ì§.ì‚¬ì›ë²ˆí˜¸ = ê´€.ì‚¬ì›ë²ˆí˜¸
    inner join (select ì‚¬ì›ë²ˆí˜¸, ì—°ë´‰ from ê¸‰ì—¬ where ì¢…ë£Œì¼ì = '9999-01-01') ê¸‰ on ê¸‰.ì‚¬ì›ë²ˆí˜¸ = ì§.ì‚¬ì›ë²ˆí˜¸
    inner join (select ë¶€ì„œë²ˆí˜¸ from ë¶€ì„œ where ë¹„ê³  = 'Active') ë¶€ on ê´€.ë¶€ì„œë²ˆí˜¸ = ë¶€.ë¶€ì„œë²ˆí˜¸
    limit 5) ë¶€ì„œê´€ë¦¬ìë“¤
    inner join (select ì‚¬ì›ë²ˆí˜¸, ì§€ì—­, ì…ì¶œì…êµ¬ë¶„, ì…ì¶œì…ì‹œê°„ from ì‚¬ì›ì¶œì…ê¸°ë¡ where ì…ì¶œì…êµ¬ë¶„ = 'O') ì‚¬ on ì‚¬.ì‚¬ì›ë²ˆí˜¸ = ë¶€ì„œê´€ë¦¬ìë“¤.ì‚¬ì›ë²ˆí˜¸
    order by ë¶€ì„œê´€ë¦¬ìë“¤.ì—°ë´‰ desc, ì‚¬.ì…ì¶œì…ì‹œê°„ desc;
    ```

    ![ìŠ¤í¬ë¦°ìƒ· 2021-10-16 ì˜¤í›„ 8 17 22](https://user-images.githubusercontent.com/43775108/137585312-73a9bc4a-9a18-4da8-906e-d2189dc91883.png)

#### index ì¶”ê°€í•˜ê¸°

ì‹¤í–‰ê³„íš ì‹¤í–‰ ì‹œ ì•„ë˜ì™€ ê°™ì´ `Full Table Scan` ì„ì„ ë³¼ ìˆ˜ ìˆì—ˆë‹¤.

![ìŠ¤í¬ë¦°ìƒ· 2021-10-16 ì˜¤í›„ 8 22 06](https://user-images.githubusercontent.com/43775108/137585475-a6e112b9-cc81-40f8-a42c-b18c704211d3.png)

í•˜ì§€ë§Œ ë¹„ìš©ê³¼ ì‹œê°„ì´ ê°€ì¥ ë§ì´ ë“œëŠ” ë¶€ë¶„ì€ ì‚¬ì›ì¶œì…ê¸°ë¡ì— ì ‘ê·¼í•˜ëŠ” ë¶€ë¶„ì´ì—ˆê³ , ì´ì— ë”°ë¼ ì‚¬ì›ë²ˆí˜¸+ì…ì¶œì…ì‹œê°„ì„ ì¸ë±ìŠ¤ë¡œ ì¡ì•„ì„œ ì²˜ë¦¬í•´ë³´ì•˜ë‹¤.

```sql
create index i_ì…ì¶œì…êµ¬ë¶„_ì‚¬ì›ë²ˆí˜¸ on ì‚¬ì›ì¶œì…ê¸°ë¡ (ì‚¬ì›ë²ˆí˜¸, ì…ì¶œì…ì‹œê°„);
```

ê²°ê³¼ëŠ” 0.013secì´ì—ˆë‹¤.

![ìŠ¤í¬ë¦°ìƒ· 2021-10-16 ì˜¤í›„ 8 34 02](https://user-images.githubusercontent.com/43775108/137585781-fa685f72-597c-4ef8-8493-63a4f45999af.png)

ì‹¤í–‰ê¸°ë¡ì—ì„œë„ full table scanì´ ì•„ë‹Œ non-unique keyë¡œ ë°”ë€Œì—ˆê³  rowì™€ ë¹„ìš©ë„ ì¤„ì–´ë“¤ì—ˆìŒì„ ì•Œ ìˆ˜ ìˆì—ˆë‹¤.

![ìŠ¤í¬ë¦°ìƒ· 2021-10-16 ì˜¤í›„ 8 34 02](https://user-images.githubusercontent.com/437
![ìŠ¤í¬ë¦°ìƒ· 2021-10-16 ì˜¤í›„ 8 35 01](https://user-images.githubusercontent.com/43775108/137585800-3b1c589f-8a25-4156-8c09-86984e7ad66a.png)

í•˜ì§€ë§Œ ì‚¬ì›ë²ˆí˜¸ë„ ë‹¨ì¼, ì…ì¶œì…ì‹œê°„ë„ ë‹¨ì¼ì¸ë° ë‘ê°œë¥¼ ê°™ì´ ê±°ëŠ” ê²ƒì— ì˜ë¯¸ê°€ ìˆì„ê¹Œ? ë¼ê³  ìƒê°í–ˆê³  ì‚¬ì›ë²ˆí˜¸ë§Œìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ ê±¸ì–´ë³´ì•˜ë‹¤.

```
create index i_ì‚¬ì›ë²ˆí˜¸ on ì‚¬ì›ì¶œì…ê¸°ë¡ (ì‚¬ì›ë²ˆí˜¸);
```

ê²°ê³¼ëŠ” 0.012secìœ¼ë¡œ ìœ ì‚¬í•˜ê±°ë‚˜ ì¡°ê¸ˆ ë¹¨ëë‹¤. 

![ìŠ¤í¬ë¦°ìƒ· 2021-10-16 ì˜¤í›„ 8 40 59](https://user-images.githubusercontent.com/43775108/137585923-180147bb-332b-41f0-8ddc-6a511b25ac97.png)

ê·¸ë ‡ë‹¤ë©´ ë” ë§ì€ ì»¬ëŸ¼ì„ ì¸ë±ìŠ¤ë¡œë¶€í„° ì–»ì–´ë‚¼ ìˆ˜ ìˆëŠ” ë³µí•© ì¸ë±ìŠ¤ê°€ ìœ ë¦¬í•˜ë‹¤ê³  íŒë‹¨í–ˆê³ , ì²«ë²ˆì§¸ ì¸ë±ìŠ¤ë¡œ ì²˜ë¦¬í•˜ì˜€ë‹¤.



### ì¸ë±ìŠ¤ ì„¤ê³„

#### Coding as a Hobbyì™€ ê°™ì€ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ì„¸ìš”.

1. ì¿¼ë¦¬

   ```sql
   select hobby, count(*) / (select count(*) from programmer)*100 as percent
   from programmer
   group by hobby desc;
   ```

   ê²°ê³¼ 441ms

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-16 ì˜¤í›„ 9 45 54](https://user-images.githubusercontent.com/43775108/137588023-9ee15078-90b9-4c86-b399-ed655cb59bae.png)

2. ì¸ë±ìŠ¤ ì ìš© 

   ```sql
   create index i_hobby on programmer (hobby);
   ```

   ê²°ê³¼ 177ms

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-16 ì˜¤í›„ 9 48 08](https://user-images.githubusercontent.com/43775108/137588118-09808615-4313-4fbd-a7bd-48c3d7be20fb.png)

3. desc ì œê±°í•˜ê³ , roundë¡œ ë°˜ì˜¬ë¦¼ ì¶”ê°€í•˜ê³ , idì— pkë¥¼ ë‹¬ì•„ì£¼ì—ˆë‹¤.

   ```sql
   select hobby, round(count(*) / (select count(*) from programmer)*100, 1)
   from programmer
   group by hobby;
   ```

   ê²°ê³¼ 50ms

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-16 ì˜¤í›„ 11 17 28](https://user-images.githubusercontent.com/43775108/137590960-9e920cfc-a037-4547-9917-d0b6a75749f7.png)

ê²°ë¡ ì ìœ¼ë¡œ ì¸ë±ìŠ¤ ì ìš©ê³¼ pkê°€ ì„±ëŠ¥ ê°œì„ ì— ê°€ì¥ í° íš¨ê³¼ë¥¼ ì¤€ ê²ƒ ê°™ë‹¤!



#### í”„ë¡œê·¸ë˜ë¨¸ë³„ë¡œ í•´ë‹¹í•˜ëŠ” ë³‘ì› ì´ë¦„ì„ ë°˜í™˜í•˜ì„¸ìš”.

1. ì¿¼ë¦¬ ì‘ì„±

   ```sql
   SELECT c.programmer_id, h.name FROM subway.covid c
   inner join programmer p on p.id = c.programmer_id
   inner join hospital h on h.id = c.hospital_id
   ```

   ê²°ê³¼ 0.030

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 12 26 17](https://user-images.githubusercontent.com/43775108/137593141-444dd791-4eca-4596-93ac-1451872a7ad2.png)

2. ì¸ë±ìŠ¤ ì ìš©

   ```sql
   create index i_covid_programmer_hospital on covid (programmer_id, hospital_id);
   create index i_hospital_id_name on hospital (id, name);
   ```

   ê²°ê³¼ 0.026

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 12 24 44](https://user-images.githubusercontent.com/43775108/137593090-ef71cbcf-b19c-426b-8414-18bc0fa58c21.png)

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 12 25 54](https://user-images.githubusercontent.com/43775108/137593123-d31ac55b-d5cb-41e8-86d5-898c7e3a2357.png)

   hospitalì—ë„ id, nameì— ì¸ë±ìŠ¤ë¥¼ ì£¼ê³  ì‹¶ì—ˆì§€ë§Œ text í˜•ì‹ì´ë¼ ì•ˆë˜ê³ , 32ê°œì˜ ë°ì´í„°ë¥¼ id, nameìœ¼ë¡œ ì¸ë±ì‹±í•˜ëŠ” ê²ƒì€ ë¶ˆí•„ìš”í•˜ë‹¤ê³  ìƒê°í–ˆëŠ”ë° ì´ ìƒê°ì´ ë§ëŠ”ì§€ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤..

#### í”„ë¡œê·¸ë˜ë°ì´ ì·¨ë¯¸ì¸ í•™ìƒ í˜¹ì€ ì£¼ë‹ˆì–´ë“¤ì´ ë‹¤ë‹Œ ë³‘ì› ì´ë¦„ì„ ë°˜í™˜í•˜ê³  id ê¸°ì¤€ ì •ë ¬

1. ì¿¼ë¦¬ ì‘ì„±

   ```sql
   select p.id, h.name
   from (select id from programmer where (hobby = 'Yes' and student = 'Yes') or years_coding = '0-2 years') p
   inner join covid c on c.programmer_id = p.id
   inner join hospital h on h.id = c.hospital_id;
   ```

   ê²°ê³¼ 0.082

2. ì¸ë±ìŠ¤ ì ìš©

   ìœ„ì—ì„œ i_covid_programmer_hospitalì„ ì ìš©í–ˆìŒì—ë„ ì¸ë±ìŠ¤ê°€ ì ìš©ë˜ì§€ ì•Šì•˜ë‹¤.

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 1 52 05](https://user-images.githubusercontent.com/43775108/137595745-223afb91-0791-4f7a-ba63-e86ea9407893.png)

   ë”°ë¼ì„œ hospital idì— pkë¥¼ ì ìš©í•´ì£¼ì—ˆë‹¤.

   ê²°ê³¼ 0.033

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 1 49 56](https://user-images.githubusercontent.com/43775108/137595686-ad9750f8-5d2e-4768-94f2-dae44d799082.png)

   ë‹¤ìŒê³¼ ê°™ì´ ì¸ë±ìŠ¤ ì ìš©ì´ ì„±ê³µì ìœ¼ë¡œ ë˜ì—ˆê³ , ì‹œê°„ë„ ì¤„ì—ˆë‹¤!

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 1 51 17](https://user-images.githubusercontent.com/43775108/137595722-ead694e3-cda3-4b20-a4a2-740b20acbf33.png)

#### ì„œìš¸ëŒ€ë³‘ì›ì— ë‹¤ë‹Œ 20ëŒ€ India í™˜ìë“¤ì„ ë³‘ì›ì— ë¨¸ë¬¸ ê¸°ê°„ë³„ë¡œ ì§‘ê³„

1. ì¿¼ë¦¬ ì‘ì„±

   ```sql
   select c.stay, count(c.id) 
   from covid c
   inner join (select id, country from programmer where country = 'India') p on p.id = c.id
   inner join (select id, age from member where age between 20 and 29) m on c.member_id = m.id
   inner join (select id from hospital where name = 'ì„œìš¸ëŒ€ë³‘ì›') h on h.id = c.hospital_id
   group by c.stay;
   ```

   ê²°ê³¼ 42ms

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 2 24 54](https://user-images.githubusercontent.com/43775108/137596632-3c4f7eff-df14-4eff-9938-8d8b6c1eb2ba.png)

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 2 26 07](https://user-images.githubusercontent.com/43775108/137596668-8055b99f-39ce-4117-bf8b-fee834f92219.png)

2. ì¸ë±ìŠ¤ ì¶”ê°€

   hospital id pk, unique ì¶”ê°€

   Programmer index ì¶”ê°€

   ```
   create index i_p on programmer (country, id);
   ```

   ê²°ê³¼ 38ms

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 2 31 12](https://user-images.githubusercontent.com/43775108/137596805-77703260-0da5-4c04-9d4c-85ca6a7ce449.png)
   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 2 31 33](https://user-images.githubusercontent.com/43775108/137596826-54018001-559b-4ca6-963e-6afb85d9dd22.png)

   ì‹œê°„ì€ í¬ê²Œ ê°œì„ ë˜ì§€ ì•Šì•˜ì§€ë§Œ programmerì˜ ë¹„ìš©ì´ ê°œì„ ë˜ì—ˆë‹¤.

#### ì„œìš¸ëŒ€ë³‘ì›ì— ë‹¤ë‹Œ 30ëŒ€ í™˜ìë“¤ì„ ìš´ë™ íšŸìˆ˜ë³„ë¡œ ì§‘ê³„í•˜ì„¸ìš”.

1. ì¿¼ë¦¬ì‘ì„±

   ```sql
   select p.exercise, count(p.id) 
   from programmer p
   inner join covid c on c.programmer_id = p.id
   inner join (select id from hospital where name = 'ì„œìš¸ëŒ€ë³‘ì›') h on h.id = c.hospital_id
   inner join (select id, age from member where age between 30 and 39) m on c.member_id = m.id
   group by p.exercise;
   ```

2. ì¸ë±ìŠ¤ ì¶”ê°€

   covidì— ì•„ë˜ ì¸ë±ìŠ¤ ì¶”ê°€

   ```
   create index i_c on covid (programmer_id, member_id, hospital_id);
   ```

   Hospital name archer(255)ë¡œ ë³€ê²½í•˜ê³  ì¸ë±ìŠ¤ ì¶”ê°€

   ```
   create index i_h on hospital (name);
   ```

   ê²°ê³¼ 67ms

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 2 58 18](https://user-images.githubusercontent.com/43775108/137597495-e1625577-0ecd-4a07-9b01-8f3910b23d4b.png)

   ![ìŠ¤í¬ë¦°ìƒ· 2021-10-17 ì˜¤ì „ 3 00 17](https://user-images.githubusercontent.com/43775108/137597561-f0f36ffa-b4e1-4384-aa9f-540161f94b4b.png)

   ì˜ ë™ì‘í•˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤!





### A. í˜ì´ì§• ì¿¼ë¦¬

ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” í…Œì´ë¸”ì˜ ë‚´ìš©ì„ 1~20ê±´ ë‹¨ìœ„ë¡œ ë‚˜ëˆ ì„œ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ì¼ë°˜ì ì…ë‹ˆë‹¤. í…Œì´ë¸”ì˜ ë ˆì½”ë“œë¥¼ ì¼ì • ë‹¨ìœ„ë¡œ ì˜ë¼ì„œ ì¡°íšŒí•˜ëŠ” ê²ƒì„ í˜ì´ì§• ì¿¼ë¦¬ë¼ê³  í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œëŠ” ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•©ë‹ˆë‹¤.

```sql
SELECT * FROM subway.programmer ORDER BY id LIMIT 20, 10;
```

ì´ë ‡ê²Œ ì‘ì„±í•  ê²½ìš°ì— 10ê°œì˜ ë ˆì½”ë“œë§Œ ì½ëŠ”ê²Œ ì•„ë‹ˆë¼, ì²«ë²ˆì§¸ ë ˆì½”ë“œë¶€í„° 20ë²ˆì§¸ ë ˆì½”ë“œê¹Œì§€ ì½ì–´ì„œ ë²„ë¦¬ê³  10ê°œì˜ ë ˆì½”ë“œë¥¼ ì½ì–´ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ì— ë’· í˜ì´ì§€ë¡œ ê°ˆìˆ˜ë¡ ì„±ëŠ¥ì´ ê¸‰ê²©íˆ ì €í•˜ë©ë‹ˆë‹¤.
ë”°ë¼ì„œ ì•„ë˜ì™€ ê°™ì´, í…Œì´ë¸”ì˜ PKë¥¼ WHERE ì¡°ê±´ì ˆì— ë„£ì–´ì£¼ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

```sql
SELECT * FROM subway.programmer
    WHERE subway.programmer.id >= 20000
        ORDER BY id LIMIT 0, 10;
```

Spring Data JPQLì€ LIMIT ëª…ë ¹ì–´ë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, Pageable ê°ì²´ë¥¼ í™œìš©í•´ì•¼ í•©ë‹ˆë‹¤.

```java
@Query("SELECT * FROM subway.programmer WHERE subway.programmer.id >= ?1")
List<User> findAll(Pageable pg);
```

## B. MySQL Replication with JPA

- MySQL Replicationì˜ master/slaveëŠ” 1:nê´€ê³„ì…ë‹ˆë‹¤.
  masterëŠ” ê°±ì‹ ì¿¼ë¦¬ë¥¼ ë°”ì´ë„ˆë¦¬ ë¡œê·¸íŒŒì¼ë¡œ ê¸°ë¡í•˜ê³ , ì´ ë¡œê·¸íŒŒì¼ì˜ ë‚´ìš©ì´ slaveë¡œ ì „ì†¡ë˜ì–´ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•¨ìœ¼ë¡œì¨ ë³µì œë©ë‹ˆë‹¤. ë”°ë¼ì„œ MySQL Replicationì€ ì¤€ë™ì‹œì„±ì…ë‹ˆë‹¤. I/O ìŠ¤ë ˆë“œê°€ ë¹„ë™ê¸°ë¡œ ë™ì‘í•˜ê¸°ì— ë§ˆìŠ¤í„°ì—ì„œ ìƒì„±í•œ ë°”ì´ë„ˆë¦¬ ë¡œê·¸ê°€ ìŠ¬ë ˆì´ë¸Œì— ìˆ˜ì‹ ë˜ê¸° ì „ì— ì¥ì• ê°€ ë‚  ê²½ìš° ì†ì‹¤ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ë°ì´í„°ì¡°ì‘ì¿¼ë¦¬(INSERT, UPDATE, DELETE)ëŠ” ë§ˆìŠ¤í„°ë¡œ, ë°ì´í„°ì¡°íšŒì¿¼ë¦¬(SELECT)ëŠ” ìŠ¬ë ˆì´ë¸Œë¡œ ë°›ì•„ì„œ ë¶€í•˜ë¥¼ ë¶„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ ì„¤ì •ì„ ì°¸ê³ í•˜ì—¬ MySQL Replication êµ¬ì„±ì„ í•´ë´…ë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ DBë¥¼ ì—°ê²°í•˜ëŠ” ì‘ì—…ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì§„í–‰í•©ë‹ˆë‹¤.

##### master ì„œë²„ ì„¤ì •

```sh
$ docker run --name mysql-master -p 13306:3306 -v ~/mysql/master:/etc/mysql/conf.d -e MYSQL_ROOT_PASSWORD=masterpw -d mysql

$ docker exec -it mysql-master /bin/bash
$ mysql -u root -p  
mysql> CREATE USER 'replication_user'@'%' IDENTIFIED WITH mysql_native_password by 'replication_pw';  
mysql> GRANT REPLICATION SLAVE ON *.* TO 'replication_user'@'%'; 

mysql> SHOW MASTER STATUS\G  
*************************** 1. row ***************************
             File: binlog.000002
         Position: 683
     Binlog_Do_DB: 
 Binlog_Ignore_DB: 
Executed_Gtid_Set: 
1 row in set (0.00 sec)
```

##### slave ì„œë²„ ì„¤ì •

```sh
$ docker run --name mysql-slave -p 13307:3306 -v ~/mysql/slave:/etc/mysql/conf.d -e MYSQL_ROOT_PASSWORD=slavepw -d mysql

$ docker exec -it mysql-slave /bin/bash
$ mysql -u root -p  

mysql> SET GLOBAL server_id = 2;
mysql> CHANGE MASTER TO MASTER_HOST='172.17.0.1', MASTER_PORT = 13306, MASTER_USER='replication_user', MASTER_PASSWORD='replication_pw', MASTER_LOG_FILE='binlog.000002', MASTER_LOG_POS=683;  

mysql> START SLAVE;  
mysql> SHOW SLAVE STATUS\G
...
            Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
```

### ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •

```sh
spring.datasource.hikari.master.username=root
spring.datasource.hikari.master.password=masterpw
spring.datasource.hikari.master.jdbc-url=jdbc:mysql://localhost:13306/subway?useSSL=false&useUnicode=yes&characterEncoding=UTF-8&serverTimezone=UTC&allowPublicKeyRetrieval=true

spring.datasource.hikari.slave.username=root
spring.datasource.hikari.slave.password=slavepw
spring.datasource.hikari.slave.jdbc-url=jdbc:mysql://localhost:13307/subway?useSSL=false&useUnicode=yes&characterEncoding=UTF-8&serverTimezone=UTC&allowPublicKeyRetrieval=true
public class ReplicationRoutingDataSource extends AbstractRoutingDataSource {
    public static final String DATASOURCE_KEY_MASTER = "master";
    public static final String DATASOURCE_KEY_SLAVE = "slave";

    @Override
    protected Object determineCurrentLookupKey() {
        boolean isReadOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();
        return (isReadOnly)
            ? DATASOURCE_KEY_SLAVE
            : DATASOURCE_KEY_MASTER;
    }
}
@Configuration
@EnableAutoConfiguration(exclude = {DataSourceAutoConfiguration.class})
@EnableTransactionManagement
@EnableJpaRepositories(basePackages = {"nextstep.subway"})
class DataBaseConfig {

    @Bean
    @ConfigurationProperties(prefix = "spring.datasource.hikari.master")
    public DataSource masterDataSource() {
        return DataSourceBuilder.create().type(HikariDataSource.class).build();
    }

    @Bean
    @ConfigurationProperties(prefix = "spring.datasource.hikari.slave")
    public DataSource slaveDataSource() {
        return DataSourceBuilder.create().type(HikariDataSource.class).build();
    }

    @Bean
    public DataSource routingDataSource(@Qualifier("masterDataSource") DataSource master,
                                        @Qualifier("slaveDataSource") DataSource slave) {
        ReplicationRoutingDataSource routingDataSource = new ReplicationRoutingDataSource();

        HashMap<Object, Object> sources = new HashMap<>();
        sources.put(DATASOURCE_KEY_MASTER, master);
        sources.put(DATASOURCE_KEY_SLAVE, slave);

        routingDataSource.setTargetDataSources(sources);
        routingDataSource.setDefaultTargetDataSource(master);

        return routingDataSource;
    }

    @Primary
    @Bean
    public DataSource dataSource(@Qualifier("routingDataSource") DataSource routingDataSource) {
        return new LazyConnectionDataSourceProxy(routingDataSource);
    }
}
    public List<Line> findLines() {    
    ...
    
    @Transactional(readOnly = true)
    public List<StationResponse> findAllStations() {
```

- `findLines()` ë©”ì„œë“œëŠ” masterì—ì„œ `findAllStations()` ë©”ì„œë“œëŠ” slaveì—ì„œ ì¡°íšŒí•©ë‹ˆë‹¤. `@Transactional(readOnly = true)`ë¥¼ ì‚¬ìš©í•  ê²½ìš° slaveë¥¼ í™œìš©í•©ë‹ˆë‹¤.

